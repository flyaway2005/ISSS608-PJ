---
title: "Data Preprocessing"
author: "Chang Fang Yu"
date-modified: "last-modified"
execute:
  echo: True
  eval: True
  warning: false
  freeze: true
---

```{r}
library(readr)
```

```{r}
pacman::p_load(ggrepel, patchwork, 
               ggthemes, hrbrthemes,
               tidyverse, plotly, 
               DT, GGally, parallelPlot, tidytext) 
pacman::p_load(igraph, tidygraph, ggraph, 
               visNetwork, lubridate, clock,
               tidyverse, graphlayouts)
```

Import data:

```{r}
GP <- read_csv("data/GovernmentProcurementviaGeBIZ.csv")
```

```{R}
glimpse(GP)
```

```{R}
sum(is.na(GP))
```

```{R}
summary(GP)

```

```{r}
colnames(GP)

```

```{r}
# æª¢æŸ¥ tender_detail_status æ¬„ä½çš„æ‰€æœ‰ä¸åŒå€¼
distinct_statuses <- GP %>%
  distinct(tender_detail_status) %>%
  pull(tender_detail_status)

# å°å‡ºæ‰€æœ‰ä¸åŒçš„ tender_detail_status
print(distinct_statuses)

```
### Data Cleaning
```{r}

#æ’é™¤ç„¡æ•ˆæ¨™æ¡ˆ"Adwarded to no suppliers"
# è¨ˆç®—æ¸…ç†å‰å¾Œçš„æ¨™æ¡ˆæ•¸é‡
before_count <- nrow(GP)
Cleaned_GP <- GP %>%
  filter(tender_detail_status %in% c("Awarded to Suppliers", "Awarded by Items", "Award by interface record"))
after_count <- nrow(Cleaned_GP)

# Display results
print(paste("Original number of tenders:", before_count))
print(paste("Number of tenders after cleaning:", after_count))

```

```{r}
# å°‡æ¸…ç†å¾Œçš„æ•¸æ“šå­˜æˆ CSV
write_csv(Cleaned_GP, "data/Cleaned_GP.csv")

# ç¢ºä¿æ–‡ä»¶æ­£ç¢ºä¿å­˜ï¼Œè®€å–å‰å¹¾ç­†è³‡æ–™æŸ¥çœ‹
Cleaned_GP_check <- read_csv("data/Cleaned_GP.csv")

# é¡¯ç¤ºå‰å¹¾ç­†è³‡æ–™ç¢ºèªæ˜¯å¦æ­£ç¢º
head(Cleaned_GP_check)
```


```{R}

library(tidyverse)

# è®€å–å·²æ¸…ç†çš„æ•¸æ“š
Cleaned_GP <- read_csv("data/Cleaned_GP.csv")

# 1ï¸âƒ£ **è½‰æ› `tender_description` ç‚ºå°å¯«**
Cleaned_GP <- Cleaned_GP %>%
  mutate(tender_description = tolower(tender_description))

# 2ï¸âƒ£ **æª¢æŸ¥ç›¸åŒ `tender_no` æ˜¯å¦æœ‰ä¸åŒçš„ `tender_description`**
tender_variations <- Cleaned_GP %>%
  group_by(tender_no) %>%
  summarise(n_unique_desc = n_distinct(tender_description), .groups = "drop") %>%
  filter(n_unique_desc > 1)  # åªä¿ç•™ `tender_no` å°æ‡‰å¤šå€‹ `tender_description` çš„æƒ…æ³

# 3ï¸âƒ£ **åˆ—å‡ºé€™äº› `tender_no` çš„è©³ç´°å…§å®¹**
tender_detail_variations <- Cleaned_GP %>%
  filter(tender_no %in% tender_variations$tender_no) %>%
  arrange(tender_no)

# 4ï¸âƒ£ **å­˜æˆ CSV ä»¥ä¾¿æª¢æŸ¥**
write_csv(tender_detail_variations, "data/tender_description_variations.csv")

# é¡¯ç¤ºçµæœ
print(paste("ç™¼ç¾", nrow(tender_variations), "å€‹ `tender_no` å…·æœ‰ä¸åŒçš„ `tender_description`"))
head(tender_detail_variations)

```

```{r}
library(tidyverse)
library(stringr)

# è®€å–æ¸…ç†å¾Œçš„æ•¸æ“š
Cleaned_GP <- read_csv("data/cleaned_GP.csv")

# 1ï¸âƒ£ **æ¸…é™¤å¤šé¤˜ç©ºæ ¼èˆ‡ç‰¹æ®Šå­—å…ƒ**
Cleaned_GP <- Cleaned_GP %>%
  mutate(
    tender_description = tolower(tender_description),   # è½‰å°å¯«
    tender_description = str_squish(tender_description), # æ¸…é™¤å¤šé¤˜ç©ºæ ¼
    tender_description = str_replace_all(tender_description, "[[:punct:]]", ""), # ç§»é™¤æ¨™é»ç¬¦è™Ÿ
    tender_description = str_replace_all(tender_description, "[^[:alnum:]\\s]", "") # ç§»é™¤éå­—æ¯æ•¸å­—å­—ç¬¦
  )

# 2ï¸âƒ£ **æª¢æŸ¥æ¸…ç†å¾Œçš„ `tender_description` æ˜¯å¦ä»æœ‰ä¸åŒè®Šç•°**
tender_variation_check <- Cleaned_GP %>%
  group_by(tender_no) %>%
  summarise(unique_desc = unique(tender_description), .groups = "drop") %>%
  filter(length(unique_desc) > 1)

# 3ï¸âƒ£ **å­˜æˆæ–°çš„ CSV**
write_csv(Cleaned_GP, "data/Cleaned_GP_cleaned.csv")

# 4ï¸âƒ£ **ç¢ºèªæ¸…ç†å¾Œçš„æ•¸æ“š**
print(nrow(tender_variation_check))  

```

```{r}
library(tidyverse)

# è®€å–å·²æ¸…ç†çš„æ•¸æ“š
Cleaned_GP <- read_csv("data/Cleaned_GP_cleaned.csv")

# 1ï¸âƒ£ **æª¢æŸ¥ `tender_description` æ˜¯å¦æœ‰é‡è¤‡**
duplicate_descriptions <- Cleaned_GP %>%
  group_by(tender_description) %>%
  summarise(n_tenders = n(), unique_tenders = n_distinct(tender_no), .groups = "drop") %>%
  filter(n_tenders > 1)  # åªä¿ç•™é‡è¤‡å‡ºç¾çš„ `tender_description`

# 2ï¸âƒ£ **é¡¯ç¤ºé‡è¤‡çš„ `tender_description`**
print(paste("ç™¼ç¾", nrow(duplicate_descriptions), "å€‹é‡è¤‡çš„ `tender_description`"))
head(duplicate_descriptions)

# 3ï¸âƒ£ **æ‰¾å‡ºè©³ç´°çš„ `tender_no` èˆ‡ `tender_description` é—œè¯**
detailed_duplicates <- Cleaned_GP %>%
  filter(tender_description %in% duplicate_descriptions$tender_description) %>%
  arrange(tender_description, tender_no)

# 4ï¸âƒ£ **å­˜æˆ CSV ä»¥ä¾¿æª¢æŸ¥**
write_csv(detailed_duplicates, "data/tender_description_duplicates.csv")

# 5ï¸âƒ£ **é¡¯ç¤ºéƒ¨åˆ†é‡è¤‡çš„ `tender_description` è¨˜éŒ„**
head(detailed_duplicates)

```

In this step, we identified that the dataset contains an excessive number of duplicate `tender_no` and `tender_description` records, differing only in supplier and awarded amount. This occurs because a single tender may be awarded to multiple suppliers for different portions of the contract.

However, for LDA (Latent Dirichlet Allocation) analysis, we are only concerned with `tender_description`. The presence of duplicated records could distort word weight distribution in the topic modeling process. Therefore, before conducting LDA, we decided to clean the dataset by keeping only the first occurrence of each unique `tender_no` and `tender_description`, removing redundant supplier records. This cleaned dataset is saved as `Cleaned_GP_LDA`.

After LDA analysis, where each tender is assigned a topic label, we merge these labels back into the original dataset (`Cleaned_GP`)â€”which was already cleaned of `"Awarded to No Suppliers"` records. This merging is performed using a left join on `tender_no` and `tender_description`, ensuring that the correct LDA label is assigned to each original tender record. The resulting dataset is called `Label_tenderClean`, which preserves supplier and awarded amount information while incorporating LDA topic labels.

### **ğŸ“‚ Final Outputs**

#### **`Cleaned_GP_LDA.csv`**

-   A dataset cleaned for LDA analysis, keeping only the first occurrence of each `tender_no` and `tender_description`.

-   This ensures that duplicate descriptions do not bias the LDA model and that each tender description is analyzed uniquely.

#### **`Label_tenderClean.csv`**

-   A dataset combining the original cleaned tenders (`Cleaned_GP`) with their LDA-assigned topic labels.

-   The LDA labels are merged back using a left join on `tender_no` and `tender_description`, ensuring consistency.

-   This dataset is used for network analysis and tender market analysis, enabling further exploration of supplier relationships and market trends across different tender categories.

```{r}
library(tidyverse)

# è®€å–å·²æ¸…ç†çš„æ•¸æ“š
CGC <- read_csv("data/Cleaned_GP_cleaned.csv")

# âœ… **å»é™¤ `tender_no` å’Œ `tender_description` é‡è¤‡çš„æ•¸æ“š**
Cleaned_GP_LDA <- CGC %>%
  distinct(tender_no, tender_description, .keep_all = TRUE)  # åªä¿ç•™ç¬¬ä¸€ç­†è¨˜éŒ„

# å­˜æˆæ–°çš„ CSV
write_csv(Cleaned_GP_LDA, "data/Cleaned_GP_LDA.csv")

# ç¢ºèªçµæœ
print(nrow(Cleaned_GP))       # åŸå§‹æ•¸æ“šè¡Œæ•¸
print(nrow(Cleaned_GP_LDA))   # æ¸…ç†å¾Œçš„æ•¸æ“šè¡Œæ•¸

```

```{r}
#å†æª¢æŸ¥ä¸€ä¸‹æ˜¯å¦é‚„æœ‰é‡è¤‡çš„"tender_no"+"tender_description"
library(tidyverse)

# è®€å–å·²æ¸…ç†çš„æ•¸æ“š
Cleaned_GP_LDA <- read_csv("data/Cleaned_GP_LDA.csv")

# 1ï¸âƒ£ **æª¢æŸ¥ `tender_no` + `tender_description` æ˜¯å¦ä»æœ‰é‡è¤‡**
duplicate_check <- Cleaned_GP_LDA %>%
  group_by(tender_no, tender_description) %>%
  summarise(count = n(), .groups = "drop") %>%
  filter(count > 1)  # åªä¿ç•™æœ‰é‡è¤‡çš„è¨˜éŒ„

# 2ï¸âƒ£ **é¡¯ç¤ºæª¢æŸ¥çµæœ**
if (nrow(duplicate_check) == 0) {
  print("âœ… No duplicate tender_no + tender_description found. The data cleaning is correct!")
} else {
  print(paste("âš ï¸ Found", nrow(duplicate_check), "duplicate records. Check the data again!"))
  head(duplicate_check)  # é¡¯ç¤ºå‰å¹¾ç­†é‡è¤‡çš„è¨˜éŒ„
}

# 3ï¸âƒ£ **ç¢ºèªæ•¸æ“šè¡Œæ•¸æ˜¯å¦æ­£ç¢º**
print(paste("Original dataset rows:", 17855))  # ä½ çš„ Cleaned_GP è¡Œæ•¸
print(paste("After cleaning, remaining rows:", nrow(Cleaned_GP_LDA)))  # ä½ çš„ Cleaned_GP_LDA è¡Œæ•¸

```

```{r}
head(Cleaned_GP_LDA)
```
```{r}
sum(is.na(Cleaned_GP_LDA))
```

